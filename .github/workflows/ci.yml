name: CI + Coverage - B√†i 8

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-analyze:
    name: Build, Test v√† Ph√¢n t√≠ch Coverage
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ‚òï Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
      
      - name: üìÅ Create output directories
        run: |
          mkdir -p bin
          mkdir -p test-bin
          mkdir -p coverage-reports
          echo "‚úÖ ƒê√£ t·∫°o th∆∞ m·ª•c bin, test-bin, coverage-reports"
      
      - name: üìã Show directory structure
        run: |
          echo "=== C·∫§U TR√öC TH∆Ø M·ª§C ==="
          ls -la
          echo ""
          echo "=== TH∆Ø M·ª§C SRC ==="
          ls -la src/ || echo "Kh√¥ng c√≥ src/"
          echo ""
          echo "=== TH∆Ø M·ª§C BIN ==="
          ls -la bin/ || echo "bin ch∆∞a c√≥"
      
      - name: üî® Compile main code
        run: |
          echo "üî® Bi√™n d·ªãch code ch√≠nh..."
          javac -cp "gson-2.10.1.jar" -d bin src/*.java
          echo "‚úÖ Bi√™n d·ªãch code ch√≠nh th√†nh c√¥ng"
          echo "üìÇ C√°c file trong bin:"
          ls -la bin/
      
      - name: üîß Compile tests (n·∫øu c√≥)
        run: |
          echo "üîß Ki·ªÉm tra tests..."
          if [ -d "test" ]; then
            mkdir -p test-bin
            javac -cp "gson-2.10.1.jar:bin" -d test-bin test/*.java
            echo "‚úÖ Bi√™n d·ªãch tests th√†nh c√¥ng"
          else
            echo "‚ö†Ô∏è Kh√¥ng c√≥ th∆∞ m·ª•c test, b·ªè qua"
          fi
      
      - name: üß™ Run tests with JaCoCo (n·∫øu c√≥)
        run: |
          if [ -d "test-bin" ] && [ -f "lib/jacocoagent.jar" ]; then
            echo "üß™ ƒêang ch·∫°y tests v√† thu th·∫≠p coverage..."
            java -javaagent:lib/jacocoagent.jar=destfile=coverage-reports/jacoco.exec \
                 -cp "gson-2.10.1.jar:bin:test-bin:lib/*" org.junit.runner.JUnitCore LibraryTest
            echo "‚úÖ Tests ho√†n t·∫•t"
          else
            echo "‚ö†Ô∏è Kh√¥ng ch·∫°y tests (thi·∫øu th∆∞ m·ª•c test-bin ho·∫∑c jacocoagent.jar)"
          fi
      
      - name: üìä Generate JaCoCo coverage report (n·∫øu c√≥)
        run: |
          if [ -f "coverage-reports/jacoco.exec" ] && [ -f "lib/jacococli.jar" ]; then
            echo "üìä T·∫°o b√°o c√°o coverage..."
            java -jar lib/jacococli.jar report coverage-reports/jacoco.exec \
                 --classfiles bin \
                 --sourcefiles src \
                 --html coverage-reports/html/ \
                 --xml coverage-reports/coverage.xml
            echo "‚úÖ B√°o c√°o coverage ƒë√£ t·∫°o"
          else
            echo "‚ö†Ô∏è Kh√¥ng t·∫°o b√°o c√°o coverage"
          fi
      
      - name: üì• Install SonarScanner
        run: |
          wget -q https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
          unzip -q sonar-scanner-cli-5.0.1.3006-linux.zip
          echo "$(pwd)/sonar-scanner-5.0.1.3006-linux/bin" >> $GITHUB_PATH
          echo "‚úÖ SonarScanner ƒë√£ c√†i ƒë·∫∑t"
      
      - name: üîç SonarCloud Scan
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          # X√°c ƒë·ªãnh tham s·ªë coverage n·∫øu c√≥
          COVERAGE_PARAM=""
          if [ -f "coverage-reports/coverage.xml" ]; then
            COVERAGE_PARAM="-Dsonar.coverage.jacoco.xmlReportPaths=coverage-reports/coverage.xml"
            echo "üìä C√≥ b√°o c√°o coverage, s·∫Ω g·ª≠i l√™n SonarCloud"
          else
            echo "‚ö†Ô∏è Kh√¥ng c√≥ b√°o c√°o coverage"
          fi
          
          sonar-scanner \
            -Dsonar.organization=phantrang-phan \
            -Dsonar.projectKey=PhanTrang-PHAN_simple-java-project \
            -Dsonar.sources=src \
            -Dsonar.java.binaries=bin \
            -Dsonar.java.libraries=gson-2.10.1.jar \
            -Dsonar.sourceEncoding=UTF-8 \
            -Dsonar.host.url=https://sonarcloud.io \
            $COVERAGE_PARAM
          echo "‚úÖ ƒê√£ g·ª≠i b√°o c√°o l√™n SonarCloud"
      
      - name: ‚¨ÜÔ∏è Upload coverage report artifact (n·∫øu c√≥)
        if: success() && hashFiles('coverage-reports/html/') != ''
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage-reports/html/